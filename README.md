此程式可以把安卓平板或手機變成Hatsune Miku: Project Diva的控制器，類似Switch版的觸控遊玩功能。  
此程式需要與運行在安卓裝置上的[ProjectDivaControllerClient](https://github.com/JamilHsu/ProjectDivaControllerClient)一起搭配使用。

![image](https://github.com/JamilHsu/ProjectDivaControllerServer/blob/master/ProjectDivaController%E9%81%8B%E4%BD%9C%E7%95%AB%E9%9D%A2.jpg?raw=true)

啟動後，會自動枚舉電腦上的IP位址，將其填入平板/手機上即可連線。  
在初次啟動時防毒軟體可能會來亂(我的這個程式能夠從網路接收攻擊者的命令並用SendInput操作你的鍵盤，桀桀桀桀)，而防火牆則會詢問是否允許存取網路。

連線的方式不拘。USB網路共享、手機行動無線基地台、電腦行動熱點、各自連線至網際網路、`adb reverse tcp:3939 tcp:3939`等都可以成功連線。根據你採用的連線方式，請選擇相應的IP位址。  
請注意，可能有多個IP位置都可以成功連線，但依據所選的IP位址，經過的路徑可能會不同。小心不要明明都接好了USB線結果實際上還是透過無線連接。  
如果你的連線是透過無線的方式連線的，那你可能必須做好被雷格大神[^Lag]針對的心理準備。在我的實測中，延遲最短的方式是透過USB網路共享，以些微的幅度勝過了`adb reverse`。

成功連線後，電腦端的主控台視窗應該會開始輸出平板上的點擊資訊與電腦上相應按下的按鍵。
理論上，這樣應該就可以用了，不過還差最後一個步驟:調整按鍵配置。
打開ProjectDivaControllerSettings.txt，編輯各按鍵(△□×◯)對應到的電腦按鍵(WSAD)。存檔後重新啟動程式。

##### 其他細節:  
儘管此程式實際上是模擬鍵盤輸入，但在設計理念上模仿的是PS4手把。比方說，在最右側判定區內按下的第一隻手指會轉換為◯對應的按鍵，而第二根則會轉換為🡆，至於第三根...什麼事也不會發生。
一旦進行了點擊，按鈕就會持續按著而不考慮手指的移動，因此就算手指移出了判定區按鈕也不會被鬆開。

滑動的判定邏輯如下:
考慮水平速度最快的兩根手指，如果其水平移動速度超過某個閥值，就會根據其位置，為其分配推動左邊或右邊的stick(搖桿)，隨後，在接下來的過程中，只要其水平速度維持在啟動閥值的1/8以上，就會持續推著stick不放。  
啟動閥值以物理距離計算。裝置的寬度越大，預設的啟動閥值也越大。你也可以在ProjectDivaControllerSettings.txt中將slide_require_multiplier設為1.0以外的值。  
滑動與點擊的判定是分開考慮的。這也意味著，進行滑動操作的點擊也會導致普通按鈕被按下，不過這應該不會影響遊戲，因為滑動從未與按鈕同時出現，另一方面，在按著HOLD時也可以透過按著HOLD的手指來執行滑動操作。  
最多只支援同時進行兩個滑動操作，因此如果是一左一右的同時按下的滑動，請不要同時在畫面上移動3根或以上的手指。例如，如果四隻手指同時輸入⇀⇀↼↼，其結果可能會是↼↼或⇀⇀或⇀↼

確認能正常運作之後，就可以把output_received_message和output_keyboard_operation設為0了。這可能可以稍微減少一點點點延遲。  
Round-Trip Time的值僅供參考，極度不準確，無法簡單的透過除以2來判斷延遲。唯一能保證的是延遲絕對不會比這還慢。現在的Round-Trip Time只是用來確認連線狀態用的Ping的副產物。  
目前的延遲測試功能測的是多次延遲之間的相對統計數值，而不是單向延遲。因為我無法準確的測出單向延遲，只好測延遲之間的相對變化量。

##### 開發者的閒聊:
從街機轉到主機後用手把玩總覺得不太順手，於是我在Switch上玩的時候總是用觸控遊玩。
後來在電腦上玩時，用鍵盤感覺更不順手了，而小街機也好貴，明明看起來結構也沒有很複雜啊! 不過就只是四個按鍵而已...ㄡ對，還有一個滑條感應器可能會複雜一點。(這時曾萌生了自製小街機控制器的念頭，但並沒有具體付諸行動的想法)

後來我想到，我們平常使用的手機/平板的螢幕，本身不就是一個功能超級加強版感應器嗎?接下來我又想到，與其使用平板作為滑條感應器，我可以直接拿平板用與Switch觸控遊玩相同的方式來玩呀！連組一個不含滑條感應器的小街機的功夫都省了。

於是接下來剩下的唯一一個問題就是，我完全沒有安卓程式開發的經驗。
不過幸好，現在的AI相當強大，雖然可能可靠性還沒有那麼好，但至少比我自己抓瞎好。

總之，在與ChatGPT數天的交流下，我成功的能將發生在平板上的觸控操作傳遞給電腦，然後於電腦端分析這些觸控資訊，並轉換為對應的鍵盤輸入。(換句話說，平板上的按鍵畫面完全是裝飾)
之所以是在電腦端而不是安卓端轉換觸控輸入，自然是因為我熟悉C++但不熟Kotlin，這樣我才能親自寫好轉換演算法。

寫完這套程式後才想到在做之前應該要先上網查查看有沒有人已經做過同樣的東西。不知為何，網路上似乎沒有其他人做過類似的東西，只有看到一個用平板作為滑條的程式，搭配自組的小街機使用。  

[^Lag]: 雷格(Lag)大神；典出蝴蝶Seba的《夢天傳說：無盡的旅程》第十章  
https://seba.tw/endless-journey-29/  
https://cxc.today/zh/@seba/work/17373/reader/113814  
(偷偷安利我最喜歡的小說家的小說)
